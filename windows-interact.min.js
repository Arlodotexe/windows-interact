const robot=require('robotjs'),exec=require('child_process').exec,fs=require('fs'),say=require('say'),requestify=require('requestify');let prefs={};function replaceAll(a,b,c){return String.raw`${a}`.replace(new RegExp(b.replace(/([.*+?^=!:${}()|\[\]\/\\\r\n\t|\n|\r\t])/g,'\\$1'),'g'),c)}function isUrl(a){return /((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=\+\$,\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=\+\$,\w]+@)[A-Za-z0-9.-]+)((?:\/[\+~%\/.\w-_]*)?\??(?:[-\+=&;%@.\w_]*)#?(?:[\w]*))?)/.test(a)}String.prototype.replaceAll=function(a,b,c){let d=''+this,e='',f=d,i=0,j=-1;for(c&&(a=a.toLowerCase(),f=d.toLowerCase());-1<(j=f.indexOf(a));)e+=d.substring(i,i+j)+b,f=f.substring(j+a.length,f.length),i+=j+a.length;return 0<f.length&&(e+=d.substring(d.length-f.length,d.length)),e};const parseAuthCode=function(a){if(a==System.prefs.masterKey)return!0;if('function'!=typeof System.prefs.authCodeParse&&null==typeof System.prefs.authCodeParse&&System.error('Type of "authCodeParse" is not a function'),'function'==typeof System.prefs.authCodeParse)return System.prefs.authCodeParse(a);else{const b=parseInt(new Date().getSeconds().toString().charAt(0));return['a','b','c','d','e','f','g','h','i','j'].indexOf(a.toLowerCase().charAt(0))===b}},authCode={isValid:function(a){return void 0===a?(System.error('No code provided'),!1):a&&parseAuthCode(a)?(a===System.prefs.masterKey?System.log('Master key authorized'):System.log('Code "'+a+'" authorized'),!0):parseAuthCode(a)?void 0:(System.log('Invalid code: "'+a+'".'),!1)}};function speak(){let a=[],b=function(b,c,d,e){function f(){a.push(b),!1===speaking.now||1==a.length?(speaking.now=!0,say.speak(a.slice(-1)[0],c,d,b=>{speaking.now=!1,a.pop(),e&&e(b)})):setTimeout(()=>{f()},250)}c||(c=System.prefs.TTSVoice),speaking={now:null},f()};return b.now=function(a,b){b||(b=System.prefs.TTSVoice),say.speak(a,b)},b.stop=function(a){say.stop(()=>{a&&a()})},b.log=function(a,b,c){System.log('(Spoken): '+a),System.speak(a,b,c)},b}function log(){function a(a,b){let c='';System.prefs.log&&System.prefs.log.showTime&&(c=new Date().toLocaleTimeString().toString()+': '),b&&!1==b.showTime&&(c=''),System.prefs.log&&System.prefs.log.outputFile&&fs.createWriteStream(System.prefs.log.outputFile,{flags:'a'}).write(c+a+'\n'),console.log(c+a)}let b=function(b,c){let d='';if(c&&(c.colour||c.color))switch(d=c.colour.toLowerCase()||c.color.toLowerCase(),d){case'red':d='\x1B[31m';break;case'green':d='\x1B[32m';break;case'yellow':d='\x1B[33m';break;case'blue':d='\x1B[34m';case'magenta':d='\x1B[35m';break;case'cyan':d='\x1B[36m';break;case'white':d='\x1B[37m';break;case'black':d='\x1B[30m';break;default:System.error('Log: Could not find the colour '+d+'. See documentation for a complete list of colours');}if(c&&(c.background||c.backgroundColor)){let a=c.background.toLowerCase()||c.backgroundColor.toLowerCase();switch(a){case'red':a='\x1B[41m';break;case'green':a='\x1B[42m';break;case'yellow':a='\x1B[43m';break;case'blue':a='\x1B[44m';case'magenta':a='\x1B[45m';break;case'cyan':a='\x1B[46m';break;case'white':a='\x1B[47m';break;case'black':a='\x1B[40m';break;default:System.error('Log: Could not find the background colour '+a+'. See documentation for a complete list of background colours');}d+=a}c?(d=d+b+'\x1B[0m',a(d,c)):a(b,c)};return b.speak=function(a,b,c,d){System.speak(a,b,c),System.log('(Spoken): '+a,d)},b}const System={prefs:prefs,authCode:authCode,path:function(a){return a=replaceAll(a.raw[0],'\\','\\\\'),'"'==a.slice(-1)&&'"'==a.charAt(0)&&(a=replaceAll(a,'"','')),a},log:log(),requestTo:function(a,b,c,d){isUrl(a)||(a=System.prefs.httpUrls[a]),'function'==typeof c?requestify[b.toLowerCase()](a).then(function(d){System.prefs.verbose.requestTo&&System.log('Sent '+b+' request to '+a),c(d.body)}):'function'==typeof b||b==null?requestify.get(a).then(function(c){System.prefs.verbose.requestTo&&System.log('Sent GET request to '+a),b&&b(c.body)}):requestify[b.toLowerCase()](a,c).then(function(c){System.prefs.verbose.requestTo&&System.log('Sent '+b+' request to '+a),d&&d(c.body)})},speak:speak(),error:function(a,b){if(''!==a&&a){let c='';System.prefs.log&&System.prefs.log.showTime&&(c=new Date().toLocaleTimeString()+': '),b&&!1==b.showTime&&(c=''),System.prefs.log.spokenErrorMessage&&!(b&&b.silent)&&System.speak(System.prefs.log.spokenErrorMessage);try{throw new Error(a)}catch(a){System.log(a.stack,{colour:'red',background:'black'})}}},cmd:function(a,b,c){exec('cmd /c "'+a+'"',function(a,d,e){if('object'==typeof b&&null==c&&(c=b,b=void 0),e&&!(c&&c.suppressErrors)&&System.error(e),b&&b(d,e),d&&!(c&&c.noLog))return console.log(d)})},PowerShell:function(a,b,c){try{a=replaceAll(a,'"','\''),System.cmd('PowerShell.exe -command "& {'+a+'}";',(a,c)=>{b&&b(a,c)},c)}catch(a){System.error(a)}},notify:function(a,b){a==null&&System.error('Cannot send notification. No message was given'),System.cmd(__dirname+'\\nircmd.exe trayballoon "'+(b?a:'')+'" "'+(b?b:a)+'" "c:\\"')},confirm:function(a,b){return new Promise(c=>{System.PowerShell('$wshell = New-Object -ComObject Wscript.Shell;$wshell.Popup("'+(b?b:a)+'",0,"'+(b?b:'Node')+'",0x1)',function(a){c(!('1'!=a.trim()))},{noLog:!0})})},alert:function(a,b){return new Promise(c=>{System.cmd(__dirname+'\\nircmd.exe infobox "'+(b?b:a)+'" "'+(b?b:'Node')+'"',()=>{c()},{noLog:!0})})},appManager:{registeredApps:{},register:function(a){let b=[],c=!1;Object.entries(a).forEach(([a,c])=>{a==null?System.error('Name not defined for registered app. You need to define a name and path to the application.'):c.path==null&&a&&System.error('Path not defined for registered app: '+a),c.id=Object.keys(System.appManager.registeredApps).length+1,System.appManager.registeredApps[a]=c;let d=System.appManager.registeredApps[a].path;'"'==d.slice(-1)&&'"'==d.charAt(0)||(d='"'+d+'"'),System.appManager.registeredApps[a].path=d;let e=d.substr(d.lastIndexOf(`\\\\`));e=replaceAll(e,'\\\\',''),e=replaceAll(e,'"',''),System.appManager.registeredApps[a].processName=e,b.push(replaceAll(e,'.exe',''))}),System.appManager.appWatcher=function(){System.PowerShell('get-process "'+b.join('", "')+'" | select ProcessName, MainWindowTitle',a=>{for(var d=0;d<b.length;d++){let e=b[d];a.includes(e)?(System.appManager.registeredApps[e].isRunning=!0,setTimeout(()=>{System.appManager.registeredApps[e].wasRunning=!0},System.prefs.appManagerRefreshInterval?System.prefs.appManagerRefreshInterval/2:2500)):(System.appManager.registeredApps[e].isRunning=!1,setTimeout(()=>{System.appManager.registeredApps[e].wasRunning=!1},System.prefs.appManagerRefreshInterval?System.prefs.appManagerRefreshInterval/2:2500)),!System.appManager.registeredApps[e].isRunning&&System.appManager.registeredApps[e].wasRunning&&System.appManager.registeredApps[e].onKill&&System.appManager.registeredApps[e].onKill(),c||(c=!0),c&&System.appManager.registeredApps[e].isRunning&&!System.appManager.registeredApps[e].wasRunning&&System.appManager.registeredApps[e].onLaunch&&System.appManager.registeredApps[e].onLaunch(),windowTitle=a.substr(a.lastIndexOf('\n'+e)),windowTitle=windowTitle.substring(0,windowTitle.indexOf('\r')),windowTitle=replaceAll(windowTitle,e,'').trim(),''==windowTitle&&(windowTitle=null),System.appManager.registeredApps[e].windowTitle=windowTitle}},{suppressErrors:!0,noLog:!0}),setTimeout(()=>{System.appManager.appWatcher()},System.prefs.appManagerRefreshInterval?System.prefs.appManagerRefreshInterval:5e3)},System.appManager.appWatcher()},launch:function(a){System.appManager.registeredApps[a]?(System.cmd(__dirname+'\\nircmd.exe execmd '+System.appManager.registeredApps[a].path),System.appManager.registeredApps[a].onLaunch&&System.appManager.registeredApps[a].onLaunch()):System.error('Unable to launch requested application. The requested app is either not registered or misspelled')},kill:function(a){System.appManager.registeredApps[a]?(System.process.kill(System.appManager.registeredApps[a].processName),System.appManager.registeredApps[a].onKill&&System.appManager.registeredApps[a].onKill()):System.error('Unable to kill requested application. The requested app is either not registered or misspelled')},hide:function(a){System.cmd(__dirname+'\\nircmd.exe win hide process "'+a+'"')},switchTo:function(a){let b=System.appManager.registeredApps[a].windowTitle,c=System.appManager.registeredApps[a].processName;b===void 0?System.error('Could not find Window title "'+b+'" or process of requested app "'+a+'". The app may not be running.'):System.PowerShell('$myshell = New-Object -com "Wscript.Shell"; $myshell.AppActivate("'+b+'")',a=>{a.includes('False')&&(System.log('Using process name as fallback. This may not be as accurate'),System.cmd(__dirname+'\\nircmd.exe win activate process "'+c+'"'))},{noLog:!0})}},process:{getPid:function(a,b){System.PowerShell('get-process -ProcessName "'+replaceAll(a,'.exe','')+'" | Format-Table id',a=>{a=replaceAll(a,'Id',''),a=replaceAll(a,'--',''),a=replaceAll(a,'\r',''),a=a.trim(),a=a.split('\n'),a=a.filter(String),b(!!a.length&&a)},{noLog:!0,suppressErrors:!0})},kill:function(a){''!=a&&a!=null&&null!=a&&System.cmd('taskkill /F /IM "'+a+'"')},onKill:function(a,b){System.PowerShell('Wait-Process -Name '+a,function(c,d){d?setTimeout(()=>{System.process.onKill(a,b)},3e3):b()},{noLog:!0,suppressErrors:!0})},getWindowTitle:function(a,b){System.PowerShell('get-process "'+replaceAll(a,'.exe','')+'" | select MainWindowTitle',function(a){output=''+a,output=replaceAll(output,'MainWindowTitle',''),output=replaceAll(output,'---------------',''),output=output.trim(),''==output&&(output=!1),b(output)},{noLog:!0,suppressErrors:!0})},isRunning:function(a,b){try{System.PowerShell('get-process "'+a+'" | select ProcessName',c=>{c.includes(a)?b(!0):b(!1)})}catch(a){System.error(a),b(!1)}}},set:{volume:function(a){System.cmd(__dirname+'\\nircmd.exe setsysvolume '+Math.floor(665.35*a))},defaultSoundDevice:function(a){System.cmd(__dirname+'\\nircmd.exe setdefaultsounddevice "'+a+'"')},location:function(a){System.log('Set location to '+a),System.currentLocation=a},preferences:function(a){for(var b in a)a.hasOwnProperty(b)&&(System.prefs[b]=a[b])}},power:{shutdown:function(a){System.cmd('shutdown.exe /s /t '+(a?a:0))},restart:function(a){System.cmd('shutdown.exe /r /t '+(a?a:0))},lock:function(a){setTimeout(()=>{System.cmd('rundll32.exe user32.dll,LockWorkStation')},a?a:0)},sleep:function(a){setTimeout(()=>{System.cmd(__dirname+'\\nircmd.exe standby')},a?a:0)},screenSaver:function(a){setTimeout(()=>{System.cmd(__dirname+'\\nircmd.exe screensaver')},a?a:0)}},window:{minimize:function(a){a===void 0?System.cmd(__dirname+'\\nircmd.exe win min foreground'):(!a.includes('.exe')&&(a+='.exe'),System.cmd(__dirname+'\\nircmd.exe win min process "'+a+'"'))},maximize:function(a){a===void 0?System.cmd(__dirname+'\\nircmd.exe win max foreground'):(!a.includes('.exe')&&(a+='.exe'),System.cmd(__dirname+'\\nircmd.exe win max process "'+a+'"'))},restore:function(a){a===void 0?System.cmd(__dirname+'\\nircmd.exe win normal foreground'):(!a.includes('.exe')&&(a+='.exe'),System.cmd(__dirname+'\\nircmd.exe win normal process "'+a+'"'))},resize:function(a,b,c){isNaN(b)&&System.error('Cannot resize: Invalid or no height was specified'),isNaN(b)&&System.error('Cannot resize: Invalid or no width was specified'),c!==void 0&&!1===isNaN(b)&&!1===isNaN(a)?(!c.includes('.exe')&&(c+='.exe'),System.window.restore(c),System.cmd(__dirname+'\\nircmd.exe win setsize process "'+c+'" x y '+a+' '+b,{suppressErrors:!0,noLog:!0})):System.cmd(__dirname+'\\nircmd.exe win setsize foreground x y '+a+' '+b,{supressErrors:!0,noLog:!0})},move:function(a,b,c){isNaN(a)&&System.error('Cannot resize: Invalid or no height was specified'),isNaN(b)&&System.error('Cannot resize: Invalid or no width was specified'),c!==void 0&&!1===isNaN(a)&&!1===isNaN(b)?(!c.includes('.exe')&&(c+='.exe'),System.window.restore(c),System.cmd(__dirname+'\\nircmd.exe win move process "'+c+'" '+a+' '+b,{suppressErrors:!0,noLog:!0})):System.cmd(__dirname+'\\nircmd.exe win setsize foreground x y '+width+' '+height,{supressErrors:!0,noLog:!0})}},showDesktop:function(){System.PowerShell('(New-Object -ComObject shell.application).toggleDesktop()')},screenshot:function(a,b){b=null==b?'*clipboard*':'"'+b+'"','full'==a?System.cmd(__dirname+'\\nircmd.exe savescreenshotfull '+b):'window'==a&&System.cmd(__dirname+'\\nircmd.exe savescreenshotwin '+b)},Cortana:{genericCommand:function(a){robot.keyTap('command'),setTimeout(()=>{robot.typeString(a),setTimeout(()=>{robot.keyTap('enter')},500)},500)},openApp:function(a){robot.keyTap('command'),setTimeout(()=>{robot.typeString('Open '+a),robot.keyTap('enter')},500)},playSong:function(a,b){System.Cortana('Play '+a+' on '+b)},playPlaylist:function(a,b){System.Cortana.genericCommand('Play my '+a+' playlist on '+b)},startListening:function(){robot.keyTap('C','command')}},pauseMedia:function(){robot.keyTap('audio_play'),System.log('Media played/paused')}};module.exports=System;